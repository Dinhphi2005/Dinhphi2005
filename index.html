<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard gi√°m s√°t pH</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 10px;
  }

  h1 {
    text-align: center;
    font-size: 22px;
    margin-bottom: 20px;
  }

  .chart-block {
    margin-bottom: 40px;
  }

  .chart-scroll {
    overflow-x: auto;
  }

  .chart-wrapper {
    min-width: 600px;
    max-width: 1000px;
    margin: auto;
  }

  canvas {
    width: 100% !important;
    height: auto !important;
  }

  button {
    margin-top: 10px;
    margin-right: 5px;
    padding: 6px 12px;
    font-size: 14px;
    border: none;
    border-radius: 6px;
    background-color: #1976d2;
    color: white;
    cursor: pointer;
  }

  button:hover {
    background-color: #125aa0;
  }

  @media screen and (max-width: 768px) {
    h1 {
      font-size: 18px;
    }

    h2 {
      font-size: 16px;
    }

    .chart-wrapper {
      min-width: 500px;
    }

    button {
      font-size: 13px;
      padding: 5px 10px;
    }
  }
</style>

</head>
<body>
  <h1>üìä Dashboard gi√°m s√°t pH</h1>

  <div class="chart-block">
    <h2>1‚É£ Bi·ªÉu ƒë·ªì th·ªùi gian th·ª±c</h2>
    <div class="chart-scroll"><div class="chart-wrapper">
      <canvas id="realTimeChart"></canvas>
    </div></div>
    <button onclick="exportChart('realTimeChart')">üìÖ T·∫£i ·∫£nh bi·ªÉu ƒë·ªì 1</button>
    <button onclick="downloadCSV()">üìÑ T·∫£i d·ªØ li·ªáu CSV</button>
  </div>

  <div class="chart-block">
    <h2>2‚É£ Bi·ªÉu ƒë·ªì trung b√¨nh tr∆∞·ª£t</h2>
    <div class="chart-scroll"><div class="chart-wrapper">
      <canvas id="avgRollingChart"></canvas>
    </div></div>
    <button onclick="exportChart('avgRollingChart')">üìÖ T·∫£i ·∫£nh bi·ªÉu ƒë·ªì 2</button>
  </div>

  <div class="chart-block">
    <h2>3‚É£ Bi·ªÉu ƒë·ªì trung b√¨nh pH theo 24 gi·ªù</h2>
    <div class="chart-scroll"><div class="chart-wrapper">
      <canvas id="avgHourChart"></canvas>
    </div></div>
    <button onclick="exportChart('avgHourChart')">üìÖ T·∫£i ·∫£nh bi·ªÉu ƒë·ªì 3</button>
    <div id="avgDateLabel" style="font-style: italic; margin-top: 5px;"></div>
  </div>

  <script>
    const apiUrl = "https://api.thingspeak.com/channels/2987877/feeds.json?api_key=O9QSTEUK3OAJGEPX&results=200";
    let realTimeChart, avgRollingChart, avgHourChart;
    let lastData = [];

    function extractHour(dateStr) {
      return new Date(dateStr).getHours();
    }

    function calcAverage(arr) {
      const sum = arr.reduce((a, b) => a + b, 0);
      return (sum / arr.length).toFixed(2);
    }

    function movingAverage(data, windowSize = 5) {
      return data.map((_, i) => {
        const window = data.slice(Math.max(i - windowSize + 1, 0), i + 1);
        const avg = window.reduce((a, b) => a + b, 0) / window.length;
        return avg.toFixed(2);
      });
    }

    function getColor(ph) {
      if (ph < 6.5) return 'red';
      else if (ph > 8.5) return 'orange';
      return 'green';
    }

    function exportChart(chartId) {
      const link = document.createElement('a');
      link.download = `${chartId}.png`;
      link.href = document.getElementById(chartId).toDataURL();
      link.click();
    }

    function downloadCSV() {
      if (!lastData.length) return;
      let csv = "Th·ªùi gian,pH\n";
      lastData.forEach(row => csv += `${row.time},${row.ph}\n`);
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "du_lieu_pH.csv";
      link.click();
    }

    function saveDataToCache(data) {
      const cache = {
        timestamp: Date.now(),
        feeds: data.feeds
      };
      localStorage.setItem("phDataCache", JSON.stringify(cache));
    }

    function loadDataFromCache() {
      const cache = localStorage.getItem("phDataCache");
      if (!cache) return null;

      const { timestamp, feeds } = JSON.parse(cache);
      const now = Date.now();

      if (now - timestamp > 24 * 60 * 60 * 1000) {
        localStorage.removeItem("phDataCache");
        return null;
      }

      return feeds;
    }

    function updateCharts() {
      const cachedFeeds = loadDataFromCache();

      if (cachedFeeds) {
        processData({ feeds: cachedFeeds });
      } else {
        fetch(apiUrl)
          .then(res => res.json())
          .then(data => {
            saveDataToCache(data);
            processData(data);
          })
          .catch(err => console.error("L·ªói t·∫£i d·ªØ li·ªáu:", err));
      }
    }

    function processData(data) {
      const feeds = data.feeds;
      lastData = feeds.map(f => ({
        time: new Date(f.created_at).toLocaleString(),
        dateObj: new Date(f.created_at),
        ph: parseFloat(f.field1)
      })).filter(f => !isNaN(f.ph));

      const timeLabels = lastData.map(f => f.time);
      const phValues = lastData.map(f => f.ph);
      const avgValues = movingAverage(phValues);

      if (!realTimeChart) {
        realTimeChart = new Chart(document.getElementById('realTimeChart').getContext('2d'), {
          type: 'line',
          data: {
            labels: timeLabels,
            datasets: [{
              label: 'pH th·ªùi gian th·ª±c',
              data: phValues,
              borderColor: 'blue',
              backgroundColor: 'rgba(0,0,255,0.1)',
              fill: true,
              tension: 0.3
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
              y: { suggestedMin: 5, suggestedMax: 9, title: { display: true, text: 'pH' } },
              x: { title: { display: true, text: 'Th·ªùi gian' } }
            }
          }
        });
      } else {
        realTimeChart.data.labels = timeLabels;
        realTimeChart.data.datasets[0].data = phValues;
        realTimeChart.update();
      }

      if (!avgRollingChart) {
        avgRollingChart = new Chart(document.getElementById('avgRollingChart').getContext('2d'), {
          type: 'line',
          data: {
            labels: timeLabels,
            datasets: [{
              label: 'pH trung b√¨nh tr∆∞·ª£t',
              data: avgValues,
              borderColor: 'green',
              backgroundColor: 'rgba(0,255,0,0.1)',
              fill: true,
              tension: 0.3
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
              y: { suggestedMin: 5, suggestedMax: 9, title: { display: true, text: 'pH' } },
              x: { title: { display: true, text: 'Th·ªùi gian' } }
            }
          }
        });
      } else {
        avgRollingChart.data.labels = timeLabels;
        avgRollingChart.data.datasets[0].data = avgValues;
        avgRollingChart.update();
      }

      const hourlyData = Array.from({ length: 24 }, () => []);
      lastData.forEach(d => hourlyData[d.dateObj.getHours()].push(d.ph));

      const labels = Array.from({ length: 24 }, (_, i) => `${i}h`);
      const avgPH = hourlyData.map(arr => arr.length ? parseFloat(calcAverage(arr)) : null);
      const barColors = avgPH.map(ph => ph !== null ? getColor(ph) : 'gray');

      const dateLabel = feeds[0] ? new Date(feeds[0].created_at).toLocaleDateString() : '';
      document.getElementById('avgDateLabel').innerText = `üìÖ D·ªØ li·ªáu ng√†y: ${dateLabel}`;

      if (!avgHourChart) {
        avgHourChart = new Chart(document.getElementById('avgHourChart').getContext('2d'), {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Trung b√¨nh pH',
              data: avgPH,
              backgroundColor: barColors
            }]
          },
          options: {
            responsive: true,
            plugins: {
              tooltip: {
                callbacks: {
                  label: ctx => `Gi·ªù ${ctx.label}: ${ctx.formattedValue}`
                }
              },
              legend: { display: false },
              datalabels: {
                anchor: 'end',
                align: 'end',
                color: '#000',
                font: { weight: 'bold', size: 10 },
                formatter: val => val !== null ? val : ''
              }
            },
            scales: {
              y: { suggestedMin: 5, suggestedMax: 9, title: { display: true, text: 'pH' } },
              x: { title: { display: true, text: 'Gi·ªù (24h)' } }
            }
          },
          plugins: [ChartDataLabels]
        });
      } else {
        avgHourChart.data.labels = labels;
        avgHourChart.data.datasets[0].data = avgPH;
        avgHourChart.data.datasets[0].backgroundColor = barColors;
        avgHourChart.update();
      }
    }

    updateCharts();
    setInterval(updateCharts, 60000); // reload m·ªói 1 ph√∫t
  </script>
</body>
</html>
